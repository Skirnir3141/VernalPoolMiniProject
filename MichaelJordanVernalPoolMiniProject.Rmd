---
title: "Prioritizing Vernal Pool Conservation In Central Massachusetts"
author: "Michael Jordan"
fontsize: 11pt
header-includes: 
 \usepackage{geometry}
 \geometry{top=2.5cm,left=2.5cm,bottom=2.5cm,right=2.5cm}
output: 
  pdf_document:
    latex_engine: xelatex
mainfont: Times New Roman
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract

Massachusetts state law protects vernal pools from development. However, this protection is contingent on a pool being certified, which can only be requested at the discretion of private citizens. To help private citizens prioritize for which pools to request certification, this paper uses cluster analysis to identify hot spots of high conservation value pools in MassGIS potential pool data.

## Introduction
```{r import, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(terra)
library(sf)
library(units)
library(scales)
library(factoextra)
library(knitr)
library(cowplot)

setwd("C:/Users/Michael Jordan/Desktop/VernalPoolMiniProject")

# Import vectors MA towns, certified pools, potential pools, and wetlands.
ma.towns <- sf::st_read("./townssurvey_shp/TOWNSSURVEY_POLY.shp")
certified.pools <- sf::st_zm(
  sf::st_read("./GISDATA_CVP_PT/GISDATA_CVP_PTPoint.shp"))
potential.pools <- sf::st_read("./pvp/PVP_PT.shp")
wetlands <- sf::st_read("./wetlandsdep/WETLANDSDEP_POLY.shp")

# Create vectors for just the towns of interest in Central MA.
cm.towns <- ma.towns[
  ma.towns$TOWN %in% c(
    "HUDSON"), ]
    #"HUDSON"), ]
cm.cp <- certified.pools[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(certified.pools)
    ))), ]
cm.pp <- potential.pools[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(potential.pools)
    ))), ]
cm.wetlands <- wetlands[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(wetlands)
    ))), ]

# Import land use tiles that intersect with towns. To do this, import tile
# indexes, convert to MA projection, get IDs of tiles overlapping with towns,
# create a list to hold tiles, import tiles by name, bind tiles together, and
# convert to MA projection.
tile.index <- sf::st_read(
  "./landcover_use_index_poly/LANDCOVER_USE_INDEX_POLY.shp")
tile.index <- sf::st_transform(tile.index, 26986)
needed.tiles <- tile.index[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(tile.index)
    ))), ]$TILENAME
tiles.l <- vector("list", length = length(needed.tiles))
for (i in 1:length(needed.tiles)) {
  shp <- sf::st_read(
    paste("./tiles/LCLU_",
      needed.tiles[i],
      "/LCLU_",
      needed.tiles[i],
      ".shp",
      sep = ""))
  tiles.l[[i]] <- shp[c("COVERCODE", "USEGENCODE")]
}
cm.tiles <- do.call(rbind, tiles.l)
cm.tiles <- sf::st_transform(cm.tiles, 26986)

# Filter tiles to include only polygons intersecting with towns.
cm.tiles <- cm.tiles[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(cm.tiles)
    ))), ]

```

Vernal pools are ephemeral bodies of water, often geographically separate from other wetlands, that typically fill in the spring and evaporate by summer (Burne & Griffin, 2005).  Because vernal pools are not filled continuously, they do not support breeding fish populations (Burne & Griffin, 2005). This makes vernal pools critical habitat for amphibian and invertebrate species, particularly those that cannot successfully reproduce in the presence of fish predation (Burne & Griffin, 2005). In the state of Massachusetts in the United States, species such as the wood frog (*Lithobates sylvaticus*), several species of mole salamanders (*Ambystoma* spp.), and various fairy shrimp species (*Eubranchipus* spp.) (MA DFG, 2009) are such obligate habitors of vernal pools. Without vernal pools, these species would be under high risk of local extinction and others that use the pools on a facultative basis would face additional pressure.

Because of their significance as critical habitat, vernal pools are protected under the Massachusetts Wetlands Protection Act (WPA), which establishes that development is not permitted within 100 feet of a vernal pool's boundary (i.e., water line) (MA DFW, 2009). However, to qualify for WPA protection, a pool must meet two criteria. First, it must exist within 100 feet of a wetland under WPA jurisdiction (MA DFW, 2009). Second, it must be certified by the Natural Heritage and Endangered Species Program (NHESP) as functioning biologically as a vernal pool (MA DFW, 2009). Fortunately, WPA jurisdiction is quite broad, encompassing essentially all wetlands in the state (310 CMR 10.02 ยง 1, 1987). But, the requirement that vernal pools be certified does significantly constrain their protection.

The reason for this is that vernal pool certification is not an active government-run process, but is instead a passive process conducted on a volunteer basis by private citizens (MA DFW, 2009). If a citizen would like to request certification of a potential vernal pool, they must visit the pool, collect biological data demonstrating the presence of certain species, and submit them to the NHESP for review. The lack of an organized active certification process has left tens of thousands of potential vernal pools for which certification has never been attempted ((`r prettyNum(nrow(potential.pools), big.mark = ",", scientific = FALSE)` in MassGIS data alone as of January 18, 2024). The sheer number of pools presents a prioritization problem for citizens who are interested in vernal pool conservation. Which pools should they review first?

In this analysis, I aim to help focus vernal pool conservation in Massachusetts by using NHESP data on potential vernal pools to identify groups of pools that should be prioritized because they are more likely to fall under WPA jurisdiction, face higher threat from development, or can be reviewed more efficiently based on their geographic clustering.

## Methods

```{r first_plot, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Plot potential pools and wetlands versus town boundaries for visual
# inspection.
terra::plot(sf::st_geometry(cm.towns), col = "white")
terra::plot(
  sf::st_geometry(cm.wetlands),
  add = TRUE,
  col = "blue")
terra::plot(
  sf::st_geometry(cm.pp),
  add = TRUE,
  col = "green",
  pch = 17,
  cex = .5)
```
I completed analysis using `r substring(R.Version()$version.string, 1, 15)`, relying primarily on the terra and sf packages (see [Rmd](https://github.com/Skirnir3141/VernalPoolMiniProject/blob/master/MichaelJordanVernalPoolMiniProject.Rmd) for full code). To keep the analysis computationally tractable, I focused on four towns in Central Massachusetts: Berlin, Bolton, Hudson, and Stow. I downloaded vectors for [municipal boundaries](https://www.mass.gov/info-details/massgis-data-municipalities), [potential vernal pools](https://www.mass.gov/info-details/massgis-data-nhesp-potential-vernal-pools), [certified vernal pools](https://www.mass.gov/info-details/massgis-data-nhesp-certified-vernal-pools), [wetland boundaries](https://www.mass.gov/info-details/massgis-data-massdep-wetlands-2005), and [land cover/use](https://www.mass.gov/info-details/massgis-data-2016-land-coverland-use) from MassGIS on January 18, 2024. Potential pools were represented as geo points identifying the center of a pool and were dated to 1993-2000. Wetlands and land cover/use were represented as polygons and were dated to 2005 and 2016 respectively. Vectors were plotted in the NAD83 / Massachusetts Mainland projection and visually inspected for errors.

```{r impervious_features, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Create an object including only polygons describing terrain that could
# indicate a threat to pools.  These are: COVERCODE 2 = Impervious, USEGENCODE 4
# = Industrial, USEGENCODE 10 = Mixed use, primarily residential, USEGENCODE 11
# = Residential - single family, USEGENCODE 12 = Residential - multi-family,
# USEGENCODE 30 = Mixed use, primarily commercial, USEGENCODE 55 = Right-of-way.
cm.tiles.f <- cm.tiles[
  cm.tiles$COVERCODE %in% c(2) |
    cm.tiles$USEGENCODE %in% c(4, 10, 11, 12, 30, 55), ]

# Check if pools overlap with an impervious feature. If they do, set their
# distance to the nearest impervious feature equal to zero. If they don't,
# calculate their distance to the nearest impervious feature in feet.
cm.pp$within.feature <- lengths(
  sf::st_intersects(
    sf::st_geometry(cm.pp),
    sf::st_geometry(cm.tiles.f)))
cm.pp.wf <- cm.pp[cm.pp$within.feature == 1, ]
cm.pp.wf$dtf <- 0
cm.pp.nwf <- cm.pp[cm.pp$within.feature == 0, ]
dist2 <- vector("list", length = nrow(cm.pp.nwf))
for (i in 1:nrow(cm.pp.nwf)) {
  dist2[i] <- units::set_units(
    min(
      sf::st_distance(
        sf::st_geometry(cm.pp.nwf)[i],
        sf::st_geometry(cm.tiles.f))),
    'ft')
}
cm.pp.nwf$dtf <- dist2
cm.pp <- rbind(cm.pp.nwf, cm.pp.wf)
```

To proxy for the threat each pool faces from human development, I measured the distance from each potential pool point to the nearest land cover/use vector that could be expected to threaten the biological functioning of a pool (e.g., industrial buildings). I defined this set of vectors based on NOAA C-CAP land cover and land use codes (see [Rmd](https://github.com/Skirnir3141/VernalPoolMiniProject/blob/master/MichaelJordanVernalPoolMiniProject.Rmd) for code mapping). I refer to this as the set of "impervious features."

```{r biology, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Create an object that combines certifed and potential pools
cm.pp.temp <- cm.pp["PVP_NUMBER"]
colnames(cm.pp.temp)[1] <- "pool_num"
cm.pp.temp$type <- "potential"
cm.cp.temp <- cm.cp["cvp_num"]
colnames(cm.cp.temp)[1] <- "pool_num"
cm.cp.temp$type <- "certified"
cm.p <- rbind(cm.pp.temp, cm.cp.temp)

# Run hierarchical cluster analysis
cm.p.dist.matrix <- sf::st_distance(cm.p, cm.p)
cm.p.clust <- hclust(as.dist(cm.p.dist.matrix), method = "single")
cm.p$clust <- cutree(cm.pp.f.clust, h = 200)

# Get clusters containing both a certified and potentialvernal pool
agg.cm.p.clust <- sf::st_drop_geometry(cm.p) %>%
  group_by(clust) %>%
  summarise(types = toString(sort(unique(type))))
hv.clust <- agg.cm.p.clust[
  agg.cm.p.clust$types == "certified, potential", ]$clust

arrange(cm.p[cm.p$clust %in% hv.clust, ], clust)

```

To proxy for the likelihood that a potential pool contains biologically relevant species (a requirement for pool certification), I used hierarchical cluster analysis with a single linkage fusion strategy to group potential and certified pools into sets based on the geodesic distance between pools. To segregate clusters, I used a 150m threshold based on the average dispersal distance of spotted salamanders (*Ambystoma maculatum*) in a radio telemetry study (McDonough & Paton, 2010). The idea here is that, if a potential pool exists in a set with a certified pool, it should be prioritized because it could plausibly be connected to a pool known to house obligate vernal pool species within the dispersal range of one of those species.

```{r wetlands, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Check whether a potential pool overlaps with a wetland. If it does, set its
# distance to the nearest wetland equal to zero. If it doesn't, calculate its
# distance to the nearest wetland in feet.
cm.pp$within.wetland <- lengths(
  sf::st_intersects(cm.pp, cm.wetlands))
cm.pp.ww <- cm.pp[cm.pp$within.wetland == 1, ]
cm.pp.ww$dtw <- 0
cm.pp.nww <- cm.pp[cm.pp$within.wetland == 0, ]
dist <- vector("list", length = nrow(cm.pp.nww))
for (i in 1:nrow(cm.pp.nww)) {
  dist[i] <- units::set_units(
    min(
      sf::st_distance(
        sf::st_geometry(cm.pp.nww)[i],
        sf::st_geometry(cm.wetlands))),
    'ft')
}
cm.pp.nww$dtw <- dist
cm.pp <- rbind(cm.pp.nww, cm.pp.ww)

# Create an object that drops potential pools that are more than 200 feet from a
# wetland.
cm.pp.f <- cm.pp[cm.pp$dtw <= 200, ]
```

Because the boundary of a pool must exist within 100 feet of a wetland for the pool to receive WPA protection, I evaluated each pool's proximity to a wetland. Pool geo points that were within 200 feet of the nearest wetland were deemed to be candidates for certification. The rest were excluded. This cut off was based on the 100 foot WPA jurisdiction threshold, plus 15 feet of imprecision in potential pool geo coords, plus half of the diameter of the size of pools reliably identified in aerial photographs (125 feet), plus a buffer (Burne, 2001). Because pool size is not identified in MassGIS data, it's possible that this excluded some valid pools.





```{r cluster, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Run cluster analysis with a single linkage fusion strategy based on a geodesic
# distance of 1/4 of a mile. This distance is arbitrary, but the idea is that
# if volunteers have to drive too far between pools, the grouping doesn't
# represent a contiguous cluster that can be efficiently evaluated. Note that
# distance is left in meters, 402m ~= .25 miles.
cm.pp.f.dist.matrix <- sf::st_distance(cm.pp.f, cm.pp.f)
cm.pp.f.clust <- hclust(as.dist(cm.pp.f.dist.matrix), method = "single")
cm.pp.f$clust <- cutree(cm.pp.f.clust, h = 402)
```

To flag groups of pools that were geographically close together and so could be reviewed efficiently, I grouped pools by running a hierarchical cluster analysis on the geodesic distances between pools using a single linkage fusion strategy. I segregated clusters based on a semi-arbitrary threshold of 1/4 of a mile, ensuring that no two pools in a cluster will be more than 1/4 of a mile apart.

```{r priority, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Create a priority index based on number of pools in the cluster and the
# average distance to an impervious feature in the cluster in tens of meters.
# Join to filtered potential pool object.
cluster.prios <- cm.pp.f %>%
  dplyr::group_by(clust) %>%
  dplyr::summarise(
    n = n(),
    town = paste0(unique(TOWN)[1]),
# Aggregating to tens of meters smooths the ranking a bit. No reason to
# privilege one pool over anotehr based on a trivial distance difference.
    avg.dtf = round((mean(unlist(dtf))) / 10)) %>%
  dplyr::mutate(
    rank.n = dplyr::dense_rank(desc(n)),
    rank.dtf = dplyr::dense_rank(avg.dtf),
    prio = dplyr::dense_rank(
      dplyr::dense_rank(desc(n)) + dplyr::dense_rank(avg.dtf)) / 2)
cluster.prios$centroid <- sf::st_centroid(cluster.prios$geometry)
cluster.prios <- sf::st_drop_geometry(cluster.prios)
cm.pp.f <- dplyr::left_join(
  cm.pp.f, cluster.prios[c("clust", "prio")], by = "clust")
```

Finally, I computed a prioritization index for each potential pool cluster. This index was an equal weighting between a dense rank of the number of pools in the cluster and a dense rank of the average distance to the nearest impervious feature (smoothed to tens of meters to prevent different pool rankings across irrelevant distances) among pools in the cluster. This index structure is (again) semi-arbitrary, but the idea is that the more pools in a group and the closer the group is to human development the more important it is to visit and review.

## Discussion

Because it combines data from different time periods, some several decades in the past (1993-2000 for potential pools, 2005 for wetlands, 2016 for land cover/use), results may not reflect current conditions. Wetlands and vernal pools may have shifted boundaries, disappeared altogether, or been developed over since the data were derived, confounding my attempts to identify high priority vernal pool clusters.

There is also likely to be bias in the potential pool data itself. Potential pools were recorded based on visual inspection of aerial photography, which is necessarily open to human error. The NHESP was able to validate that the false positve rate was low (less than 3%), but it was unable to validate the false negative rate (Burne, 2001). It could be quite high because small pools below ~50-60 feet in diameter could not be reliably identified given the granularity of the aerial photographs (Burne, 2001).

Finally, the prioritization index does not account for whether a potential pool is likely to contain species that would allow it to be certified as a functioning vernal pool. This is a significant omission from pool prioritization because it is a hard requirement for pool certification.

## Results

`r nrow(cm.pp[cm.pp$dtw > 150, ])` potential pools were excluded because they were not in close enough proximity to a wetland to fall under WPA jurisdiction. This allowed me to cut down the data set by `r scales::percent(round(nrow(cm.pp[cm.pp$dtw > 150, ]) / nrow(cm.pp), digits = 2))` and prevent wasted effort on pools that are unlikely to be protected by the WPA.

Within the remaining `r nrow(cm.pp.f)` pools, I produced a map that citizen groups can use to identify hot spots of high value potential pools (coded in a heat map with more yellow colors indicating higher value). To validate, I also produced a zoomed in map and plotted potential pools, potential pools removed from the data set, wetlands, and impervious features.

```{r results_map, echo=FALSE, fig.height=2, fig.align='center', error=FALSE, warning=FALSE, message=FALSE}

# Set graphical parameters
par(mfrow = c(1, 2), mar = c(1, 1, 1, 1))

# Add town centroid for label plotting. Create plot of potential pools versus
# wetlands in all towns.
cm.towns <- cbind(cm.towns, st_coordinates(st_centroid(cm.towns)))
plot.all <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = cm.towns, fill = "white") +
  ggplot2::geom_sf(data = cm.wetlands, fill = "blue") +
  ggplot2::geom_sf(data = cm.pp.f, aes(color = prio), pch = 20, cex = 5) +
  ggplot2::scale_color_gradient(
    low="darkred", high="yellow", trans = "reverse", name = "Pool\nPrio") + 
  ggplot2::geom_label(
    data = cm.towns, aes(X, Y, label = TOWN), size = 4, fontface = "bold") +
  ggplot2::theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    rect = element_blank(),
    legend.margin = margin( 0, 0, 0, 0),
    legend.box.margin = margin(0, 0, 0, 0))

# Set extent, create object for deleted pools, and plot potential pools versus
# wetlands, impervious features, and pools removed from analysis for a zoomed in
# area of Hudson.
ext <- c(xmin = 196687.2, ymin = 903000, xmax = 202250.2, ymax = 906000)
cm.pp.del <- cm.pp[cm.pp$dtw > 150, ]
cm.pp.del$del <- ""
plot.zoom <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = sf::st_crop(cm.towns, ext), fill = "white") +
  ggplot2::geom_sf(data = sf::st_crop(cm.wetlands, ext), fill = "blue") +
  ggplot2::geom_sf(data = sf::st_crop(cm.tiles.f, ext), fill = "grey") +
  ggplot2::geom_sf(
    data = sf::st_crop(cm.pp.f, ext), aes(color = prio), pch = 20, cex = 5) +
  ggplot2::scale_color_gradient(
    low="darkred", high="yellow", trans = "reverse", guide = "none") + 
  ggplot2::geom_sf(
    data = sf::st_crop(cm.pp.del, ext), aes(fill = del), pch = 13, cex = 5) +
  ggplot2::guides(fill = ggplot2::guide_legend(title = "Excluded\nPool")) +
  ggplot2::theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    rect = element_blank(),
    legend.margin = margin( 0, 0, 0, 0),
    legend.box.margin = margin(0, 0, 0, 0))

# Plot maps side-by-side
cowplot::plot_grid(plot.all, plot.zoom, labels = c("Overview", "Zoomed In Region"))
```
In addition to maps, geo coordinates of clusters and pools can be provided to interested citizen groups.

## Conclusion

I was able to filter potential vernal pools, map them, and apply a reasonable index to prioritize which pools to review.

In future work, I'd like to expand this analysis to the entire state and address the potential sources of bias discussed above. Additionally, I'd like to move beyond back-of-the-envelope indexing and create a statistical model to predict which potential pools are likely to be strong candidates for certification. To do this, I would ideally have access to data on pools that were previously on the potential pool list, were reviewed, and the outcome of that review. Perhaps in the future such data could be compiled in partnership with citizen groups. Alternatively, I could explore using data on currently certified pools to extrapolate predictors.

## Reference List

Burne, R.M. (2001) [Massachusetts Aerial Photo Survey of Potential Vernal Pools](https://www.mass.gov/doc/massachusetts-aerial-photo-survey-of-potential-vernal-pools/download) (2001). Natural Heritage & Endangered Species Program, Massachusetts Division of Fisheries and Wildlife.

Burne, R.B. & Griffin, C.R. (2005) Protecting vernal pools: a model from Massachusetts, USA. *Wetlands ecology and management*. Vol. 13 (3), 367-375. https://doi.org/10.1007/s11273-004-7528-3

[Guidelines for The Certification of Vernal Pool Habitat](https://www.mass.gov/doc/guidelines-for-the-certification-of-vernal-pool-habitat/download) (2009), Massachusetts Division Of Fisheries & Wildlife.

[Intricate Fairy Shrimp](https://www.mass.gov/doc/intricate-fairy-shrimp/download) (2015), Natural Heritage and Endangered Species Program, Massachusetts Division Of Fisheries & Wildlife.

McDonough, C. & Paton, P. (2010) Salamander Dispersal Across a Forested Landscape Fragmented by a Golf Course. *The Journal of Wildlife Management*. Vol. 71 (4), 1163-1169. https://doi.org/10.2193/2006-380

[Wetlands Protection Act](https://www.mass.gov/doc/310-cmr-1000-the-wetlands-protection-act/download) (1987)

\newpage
## Working Style Assessment
