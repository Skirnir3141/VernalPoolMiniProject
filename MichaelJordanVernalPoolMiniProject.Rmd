---
title: "Prioritizing Vernal Pool Conservation In Central Massachusetts"
author: "Michael Jordan"
date: "January 25, 2024"
header-includes: 
 \usepackage{geometry}
 \geometry{top=.7in,left=.7in,bottom=.7in,right=.7in}
output: pdf_document
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract

Vernal pools are protected under Massachusetts state law due to their function as critical wildlife habitat. However, in order to receive this protection a pool must receive a government certification. Unfortunately, the Massachusetts government does not actively attempt to certify new pools and instead relies on private citizens submitting certification requests at their discretion. Because there is no active certification process, it is likely that many legitimate vernal pools remain uncertified and unprotected. To help citizen groups more effectively protect vernal pools, this paper uses a MassGIS data set of potential vernal pools to identify geographic "hot spots" of pools that should be prioritized for attempted certification.

## Introduction
```{r import, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(terra)
library(sf)
library(units)
library(scales)
library(factoextra)
library(knitr)
library(cowplot)

setwd("C:/Users/Michael Jordan/Desktop/VernalPoolMiniProject")

# Import vectors MA towns, certified pools, potential pools, and wetlands.
ma.towns <- sf::st_read("./townssurvey_shp/TOWNSSURVEY_POLY.shp")
certified.pools <- sf::st_read("./GISDATA_CVP_PT/GISDATA_CVP_PTPoint.shp")
potential.pools <- sf::st_read("./pvp/PVP_PT.shp")
wetlands <- sf::st_read("./wetlandsdep/WETLANDSDEP_POLY.shp")

# Create vectors for just the towns of interest in Central MA.
cm.towns <- ma.towns[
  ma.towns$TOWN %in% c(
    "BERLIN", "BOLTON", "HUDSON", "STOW"), ]
    #"HUDSON"), ]
cm.cp <- certified.pools[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(sf::st_zm(certified.pools))
    ))), ]
cm.pp <- potential.pools[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(sf::st_zm(potential.pools))
    ))), ]
cm.wetlands <- wetlands[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(wetlands)
    ))), ]

# Import land use tiles that intersect with towns. To do this, import tile
# indexes, convert to MA projection, get IDs of tiles overlapping with towns,
# create a list to hold tiles, import tiles by name, bind tiles together, and
# convert to MA projection.
tile.index <- sf::st_read(
  "./landcover_use_index_poly/LANDCOVER_USE_INDEX_POLY.shp")
tile.index <- sf::st_transform(tile.index, 26986)
needed.tiles <- tile.index[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(tile.index)
    ))), ]$TILENAME
tiles.l <- vector("list", length = length(needed.tiles))
for (i in 1:length(needed.tiles)) {
  shp <- sf::st_read(
    paste("./tiles/LCLU_",
      needed.tiles[i],
      "/LCLU_",
      needed.tiles[i],
      ".shp",
      sep = ""))
  tiles.l[[i]] <- shp[c("COVERCODE", "USEGENCODE")]
}
cm.tiles <- do.call(rbind, tiles.l)
cm.tiles <- sf::st_transform(cm.tiles, 26986)

# Filter tiles to include only polygons intersecting with towns.
cm.tiles <- cm.tiles[unlist(
  unique(
    sf::st_intersects(
      x = sf::st_geometry(cm.towns),
      y = sf::st_geometry(cm.tiles)
    ))), ]

```

Vernal pools are ephemeral bodies of water, often geographically separate from other wetlands, that typically fill in the spring and evaporate by summer (Burne & Griffin, 2005).  Because vernal pools are not filled continuously, they do not support breeding fish populations (Burne & Griffin, 2005). This makes vernal pools critical habitat for amphibian and invertebrate species, particularly those that cannot successfully reproduce in the presence of fish predation (Burne & Griffin, 2005).

In the state of Massachusetts in the United States, a variety of species are such obligate habitators of vernal pools, including the wood frog (*Lithobates sylvaticus*), several species of mole salamanders (*Ambystoma* spp.), and various fairy shrimp species (*Eubranchipus* spp.) (MA DFG, 2009). The intricate fairy shrimp (*Eubranchipus intricatus*) is of particular note because it is locally rare and is listed as a Species of Special Concern under the Massachusetts Endangered Species Act (NHESP, 2015). Without vernal pools, these species would be under high risk of local extinction and others that use the pools on a facultative basis would face additional pressure.

Because of their significance as critical habitat, vernal pools are protected under several Massachusetts laws, the most significant of which is the Wetlands Protection Act (WPA). Under the WPA, development that may impact the function of a vernal pool as wildlife habitat is not permitted within 100 feet of the boundary of a vernal pool (MA DFW, 2009). To qualify for WPA protection, a pool must meet two criteria. First, it must exist within 100 feet of a wetland “Resource Area” that falls under WPA jurisdiction (MA DFW, 2009). Second, it must be certified by the Natural Heritage and Endangered Species Program (NHESP) as functioning biologically as a vernal pool (MA DFW, 2009).

Fortunately, WPA jurisdiction is quite broad, encompassing essentially all wetlands in Massachusetts (310 CMR 10.02 § 1, 1987). But, the requirement that vernal pools be certified does significantly constrain their protection. This is because certification is a passive process conducted on a volunteer basis by private citizens, not an active process by a government body (MA DFW, 2009). If a citizen would like to request certification of a potential vernal pool, they must visit the pool, collect biological data demonstrating the presence of certain species, and submit them to the NHESP for review.  Only once approved as a certified vernal pool and only once it has been established that the pool falls under WPA jurisdiction is it protected from development.

To aid the protection of vernal pools, the NHESP used aerial photography to develop a data set of GIS coordinates of potential vernal pools that are not yet certified (Burne, 2001). This data set is a useful starting point for citizen groups that would like to review potential vernal pools and submit them for certification. However, the volume of records in this data set (`r prettyNum(nrow(potential.pools), big.mark = ",", scientific = FALSE)` as of January 18, 2024) presents a prioritization problem. Citizen groups may have limited time to visit pools, gather data, and request certification. It's unclear on which pools they should focus their limited resources.

In this analysis, I aim to contribute to vernal pool conservation in Massachusetts by flagging pools in the NHESP potential pool data set that are more likely to benefit from protection, face higher threat from development, and can be reviewed more efficiently based on their geographic clustering.

## Methods

```{r first_plot, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Plot potential pools and wetlands versus town boundaries for visual
# inspection.
terra::plot(sf::st_geometry(cm.towns), col = "white")
terra::plot(
  sf::st_geometry(cm.wetlands),
  add = TRUE,
  col = "blue")
terra::plot(
  sf::st_geometry(sf::st_zm(cm.pp)),
  add = TRUE,
  col = "green",
  pch = 17,
  cex = .5)
```
For this analysis, I used `r substring(R.Version()$version.string, 1, 15)`, relying primarily on the terra and sf packages (see [Rmd](https://github.com/Skirnir3141/VernalPoolMiniProject/blob/master/MichaelJordanVernalPoolMiniProject.Rmd) for full code). To make the analysis computationally tractable, I chose to focus on four towns in Central Massachusetts: Berlin, Bolton, Hudson, and Stow. Vectors for [municipal boundaries](https://www.mass.gov/info-details/massgis-data-municipalities), [potential vernal pools](https://www.mass.gov/info-details/massgis-data-nhesp-potential-vernal-pools), [wetland boundaries](https://www.mass.gov/info-details/massgis-data-massdep-wetlands-2005), and [land cover/use](https://www.mass.gov/info-details/massgis-data-2016-land-coverland-use) were downloaded from the MassGIS website on January 18, 2024. Potential pools were represented as geo points identifying the center of a pool and were dated to 1993-2000. Wetlands and land cover/use were represented as polygons and were dated to 2005 and 2016 respectively. Potential pools and wetlands were plotted versus municipal boundaries in the NAD83 / Massachusetts Mainland projection and visually inspected for errors.

```{r wetlands, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Check whether a potential pool overlaps with a wetland. If it does, set its
# distance to the nearest wetland equal to zero. If it doesn't, calculate its
# distance to the nearest wetland in feet.
cm.pp$within.wetland <- lengths(
  sf::st_intersects(cm.pp, cm.wetlands))
cm.pp.ww <- cm.pp[cm.pp$within.wetland == 1, ]
cm.pp.ww$dtw <- 0
cm.pp.nww <- cm.pp[cm.pp$within.wetland == 0, ]
dist <- vector("list", length = nrow(cm.pp.nww))
for (i in 1:nrow(cm.pp.nww)) {
  dist[i] <- units::set_units(
    min(
      sf::st_distance(
        sf::st_geometry(cm.pp.nww)[i],
        sf::st_geometry(cm.wetlands))),
    'ft')
}
cm.pp.nww$dtw <- dist
cm.pp <- rbind(cm.pp.nww, cm.pp.ww)
```

Because a pool must exist within 100 feet of a wetland to be eligible for WPA protection, I evaluated each pool's proximity to a wetland. Pool geo points that were within 130 feet of the nearest wetland were deemed to be candidates for certification and the rest were discarded. This 130 foot cut off was based on the 100 foot WPA threshold plus +/- 15 feet imprecision in potential pool geo points (Burne, 2001). Note that because WPA jurisdiction is based on pool boundary and potential pool geo points represent the pool center, this is a stringent threshold and could cut off some pools within WPA jurisdiction.

```{r impervious_features, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Create an object including only polygons describing terrain that could
# indicate a threat to pools.  These are: COVERCODE 2 = Impervious, USEGENCODE 4
# = Industrial, USEGENCODE 10 = Mixed use, primarily residential, USEGENCODE 11
# = Residential - single family, USEGENCODE 12 = Residential - multi-family,
# USEGENCODE 30 = Mixed use, primarily commercial, USEGENCODE 55 = Right-of-way.
cm.tiles.f <- cm.tiles[
  cm.tiles$COVERCODE %in% c(2) |
    cm.tiles$USEGENCODE %in% c(4, 10, 11, 12, 30, 55), ]

# Check if pools overlap with an impervious feature. If they do, set their
# distance to the nearest impervious feature equal to zero. If they don't,
# calculate their distance to the nearest impervious feature in feet.
cm.pp$within.feature <- lengths(
  sf::st_intersects(
    sf::st_geometry(cm.pp),
    sf::st_geometry(cm.tiles.f)))
cm.pp.wf <- cm.pp[cm.pp$within.feature == 1, ]
cm.pp.wf$dtf <- 0
cm.pp.nwf <- cm.pp[cm.pp$within.feature == 0, ]
dist2 <- vector("list", length = nrow(cm.pp.nwf))
for (i in 1:nrow(cm.pp.nwf)) {
  dist2[i] <- units::set_units(
    min(
      sf::st_distance(
        sf::st_geometry(cm.pp.nwf)[i],
        sf::st_geometry(cm.tiles.f))),
    'ft')
}
cm.pp.nwf$dtf <- dist2
cm.pp <- rbind(cm.pp.nwf, cm.pp.wf)

# Create an object that drops potential pools that are more than 130 feet from a
# wetland. This accounts for the 100 foot rule and +/- 15 foot imprecision in
# point generation.
cm.pp.f <- cm.pp[cm.pp$dtw <= 130, ]
```

To proxy for the threat each pool faced from human development, I measured the distance from each potential pool point to the nearest land cover/use vector that could be expected to threaten the biological functioning of a pool (e.g., a road or industrial building). I defined this set of vectors based on NOAA C-CAP land cover and land use codes (see [Rmd](https://github.com/Skirnir3141/VernalPoolMiniProject/blob/master/MichaelJordanVernalPoolMiniProject.Rmd) for code mapping). I refer to this below as the set of "impervious features."

```{r cluster, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Run cluster analysis with a single linkage fusion strategy based on a geodesic
# distance of 1/4 of a mile. This distance is arbitrary, but the idea is that
# if volunteers have to drive too far between pools, the grouping doesn't
# represent a contiguous cluster that can be efficiently evaluated. Note that
# distance is left in meters, 402m ~= .25 miles.
dist.matrix <- sf::st_distance(cm.pp.f, cm.pp.f)
cm.pp.f.clust <- hclust(as.dist(dist.matrix), method = "single")
cm.pp.f$clust <- cutree(cm.pp.f.clust, h = 402)
```

To flag groups of pools that were geographically close together and so could be visited and reviewed for certification quickly, I grouped pools into clusters by running a hierarchical cluster analysis on the geodesic "great circle" distances between pools using a single linkage fusion strategy. I segregated clusters based on a semi-arbitrary threshold of 1/4 of a mile. My goal in doing so was to define pool clusters that would feel contiguous to volunteers. This approach ensures that no two pools in a cluster will be more than 1/4 of a mile apart, which seems reasonable.

```{r priority, include=FALSE, error=FALSE, warning=FALSE, message=FALSE}
# Create a priority index based on number of pools in the cluster and the
# average distance to an impervious feature in the cluster in tens of meters.
# Join to filtered potential pool object.
cluster.prios <- cm.pp.f %>%
  dplyr::group_by(clust) %>%
  dplyr::summarise(
    n = n(),
    town = paste0(unique(TOWN)[1]),
# Aggregating to tens of meters smooths the ranking a bit. No reason to
# privilege one pool over anotehr based on a trivial distance difference.
    avg.dtf = round((mean(unlist(dtf))) / 10)) %>%
  dplyr::mutate(
    rank.n = dplyr::dense_rank(desc(n)),
    rank.dtf = dplyr::dense_rank(avg.dtf),
    prio = dplyr::dense_rank(
      dplyr::dense_rank(desc(n)) + dplyr::dense_rank(avg.dtf)) / 2)
cluster.prios$centroid <- sf::st_centroid(cluster.prios$geometry)
cluster.prios <- sf::st_drop_geometry(cluster.prios)
cm.pp.f <- dplyr::left_join(
  cm.pp.f, cluster.prios[c("clust", "prio")], by = "clust")
```

Finally, I computed a prioritization index for each potential pool cluster. This index was an equal weighting between a dense rank of the number of pools in the cluster and a dense rank of the average distance to the nearest impervious feature (smoothed to tens of meters to prevent different pool rankings across irrelevant distances) among pools in the cluster. This index structure is (again) semi-arbitrary, but the idea is that the more pools in a group and the closer the group is to human development the more important it is to visit and review.

## Discussion

This is a quick-and-dirty back-of-the-envelope analytical approach that may suffer from several sources of bias.

Because it combines data from different time periods, some several decades in the past (1993-2000 for potential pools, 2005 for wetlands, 2016 for land cover/use), results may not reflect current conditions. Wetlands and vernal pools may have shifted boundaries, disappeared altogether, or been developed over since the data were derived, confounding my attempts to identify high priority vernal pool clusters.

There is also likely to be bias in the potential pool data itself. Potential pools were recorded based on visual inspection of aerial photography, which is necessarily open to human error. The NHESP was able to validate that the false positve rate was low (less than 3%), but it was unable to validate the false negative rate (Burne, 2001). It could be quite high because small pools below ~50-60 feet in diameter could not be reliably identified given the granularity of the aerial photographs (Burne, 2001).

Finally, the prioritization index does not account for whether a potential pool is likely to contain species that would allow it to be certified as a functioning vernal pool. This is a significant omission from pool prioritization because it is a hard requirement for pool certification.

## Results

`r nrow(cm.pp[cm.pp$dtw > 150, ])` potential pools were excluded because they were not in close enough proximity to a wetland to fall under WPA jurisdiction. This allowed me to cut down the data set by `r scales::percent(round(nrow(cm.pp[cm.pp$dtw > 150, ]) / nrow(cm.pp), digits = 2))` and prevent wasted effort on pools that are unlikely to be protected by the WPA.

Within the remaining `r nrow(cm.pp.f)` pools, I produced a map that citizen groups can use to identify hot spots of high value potential pools (coded in a heat map with more yellow colors indicating higher value). To validate, I also produced a zoomed in map and plotted potential pools, potential pools removed from the data set, wetlands, and impervious features.

```{r results_map, echo=FALSE, fig.height=2, fig.align='center', error=FALSE, warning=FALSE, message=FALSE}

# Set graphical parameters
par(mfrow = c(1, 2), mar = c(1, 1, 1, 1))

# Add town centroid for label plotting. Create plot of potential pools versus
# wetlands in all towns.
cm.towns <- cbind(cm.towns, st_coordinates(st_centroid(cm.towns)))
plot.all <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = cm.towns, fill = "white") +
  ggplot2::geom_sf(data = cm.wetlands, fill = "blue") +
  ggplot2::geom_sf(data = cm.pp.f, aes(color = prio), pch = 20, cex = 5) +
  ggplot2::scale_color_gradient(
    low="darkred", high="yellow", trans = "reverse", name = "Pool\nPrio") + 
  ggplot2::geom_label(
    data = cm.towns, aes(X, Y, label = TOWN), size = 4, fontface = "bold") +
  ggplot2::theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    rect = element_blank(),
    legend.margin = margin( 0, 0, 0, 0),
    legend.box.margin = margin(0, 0, 0, 0))

# Set extent, create object for deleted pools, and plot potential pools versus
# wetlands, impervious features, and pools removed from analysis for a zoomed in
# area of Hudson.
ext <- c(xmin = 196687.2, ymin = 903000, xmax = 202250.2, ymax = 906000)
cm.pp.del <- cm.pp[cm.pp$dtw > 150, ]
cm.pp.del$del <- ""
plot.zoom <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = sf::st_crop(cm.towns, ext), fill = "white") +
  ggplot2::geom_sf(data = sf::st_crop(cm.wetlands, ext), fill = "blue") +
  ggplot2::geom_sf(data = sf::st_crop(cm.tiles.f, ext), fill = "grey") +
  ggplot2::geom_sf(
    data = sf::st_crop(cm.pp.f, ext), aes(color = prio), pch = 20, cex = 5) +
  ggplot2::scale_color_gradient(
    low="darkred", high="yellow", trans = "reverse", guide = "none") + 
  ggplot2::geom_sf(
    data = sf::st_crop(cm.pp.del, ext), aes(fill = del), pch = 13, cex = 5) +
  ggplot2::guides(fill = ggplot2::guide_legend(title = "Excluded\nPool")) +
  ggplot2::theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    rect = element_blank(),
    legend.margin = margin( 0, 0, 0, 0),
    legend.box.margin = margin(0, 0, 0, 0))

# Plot maps side-by-side
cowplot::plot_grid(plot.all, plot.zoom, labels = "AUTO")
```
In addition to maps, geo coordinates of clusters and pools can be provided to interested citizen groups.

```{r results_table, echo=FALSE, fig.align='center', error=FALSE, warning=FALSE, message=FALSE}

table.output <- dplyr::arrange(
  cluster.prios[c("town", "prio", "n", "avg.dtf", "centroid")],
  prio)[1:5, ]
colnames(table.output) <- c(
  "Town", "Priority", "No. of Pools", "Avg Distance To Impervious Feature (10m)",
  "Cluster GIS Coords")
knitr::kable(
  table.output,
  align = "c",
  caption = "Cluster Geo Coords & Ranking")
```

## Conclusion

I was able to filter potential vernal pools, map them, and apply a reasonable index to prioritize which pools to review.

In future work, I'd like to expand this analysis to the entire state and address the potential sources of bias discussed above. Additionally, I'd like to move beyond back-of-the-envelope indexing and create a statistical model to predict which potential pools are likely to be strong candidates for certification. To do this, I would ideally have access to data on pools that were previously on the potential pool list, were reviewed, and the outcome of that review. Perhaps in the future such data could be compiled in partnership with citizen groups. Alternatively, I could explore using data on currently certified pools to extrapolate predictors.

## Reference List

Burne, R.B. & Griffin, C.R. (2005) Protecting vernal pools: a model from Massachusetts, USA. *Wetlands ecology and management*. Vol.13 (3), 367-375. https://doi.org/10.1007/s11273-004-7528-3

[Guidelines for The Certification of Vernal Pool Habitat](https://www.mass.gov/doc/guidelines-for-the-certification-of-vernal-pool-habitat/download) (2009), Massachusetts Division Of Fisheries & Wildlife.

[Intricate Fairy Shrimp](https://www.mass.gov/doc/intricate-fairy-shrimp/download) (2015), Natural Heritage and Endangered Species Program, Massachusetts Division Of Fisheries & Wildlife.

Burne, R.M. (2001) [Massachusetts Aerial Photo Survey of Potential Vernal Pools](https://www.mass.gov/doc/massachusetts-aerial-photo-survey-of-potential-vernal-pools/download) (2001). Natural Heritage & Endangered Species Program, Massachusetts Division of Fisheries and Wildlife.

[Wetlands Protection Act](https://www.mass.gov/doc/310-cmr-1000-the-wetlands-protection-act/download) (1987)